---
title: "afc_grad_env"
author: "Rémi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(NetworkEnvGradGeneration)
library(ade4)

getwd()
# setwd("../../")
getwd()
source("plot.R")
source("formatting.R")
library(ggplot2)
```

# Analysing changes in abundance with AFC

```{r}
# set.seed(0)
nb_frame <- 10; env_grad_max = 10
spe_resource <-15; spe_consum <- 25
mean_tol_env = 1.5; sd_tol_env = 1
simulated_network <- env_grad_netw(nb_resource =spe_resource , nb_consumer = spe_consum,
                                   nb_location = nb_frame, env_grad_max = env_grad_max, 
                                   ninter = 200, 
                                   mean_tol_env = mean_tol_env, sd_tol_env = sd_tol_env)

row.names(simulated_network$abudance$abundance_resource) <- paste0("site",1:nb_frame)
row.names(simulated_network$abudance$abundance_consumer) <- paste0("site",1:nb_frame)
```

```{r}

```


```{r}
plot_matrix(data.frame(simulated_network$th_network[[1]]), 
          max_size = 15) +
theme(axis.text = element_blank(),
      axis.text.x.top = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid.major = element_blank(),
      legend.position="none",
      plot.background = element_blank(),
      axis.line.x.top = element_line(colour = "darkorange4",
                                     linewidth = 3),
      axis.line.y = element_line(colour = "green4", 
                                 linewidth = 3))
```

```{r}
plot_matrix(data.frame(simulated_network$obs_network[[1]]), 
          max_size = 15) +
theme(axis.text = element_blank(),
      axis.text.x.top = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid.major = element_blank(),
      legend.position="none",
      plot.background = element_blank(),
      axis.line.x.top = element_line(colour = "darkorange4",
                                     linewidth = 3),
      axis.line.y = element_line(colour = "green4", 
                                 linewidth = 3))
```

```{r}
table.value(simulated_network$abudance$abundance_resource)
```

```{r}
table.value(simulated_network$abudance$abundance_consumer)
```

```{r}
afc = dudi.coa(simulated_network$abudance$abundance_resource, scannf = F, nf = 2)
scatter(afc)

scatter(dudi.coa(simulated_network$th_network[[1]], scannf = F, nf = 2))
# scatter(dudi.coa(simulated_network$obs_network[[1]], scannf = F, nf = 2))
# je ne sais pas pourquoi ça ne fonctionne pas
```

```{r}
table.value(simulated_network$th_network[[4]])
table.value(simulated_network$obs_network[[4]])
```


Ici, on a deux eigenvalues dominantes ainsi c'est top pour le graphique en 2D.

On observe bien un effet fer à cheval (ou aussi dit guttman) ce qui est rassurant vu que l'on a généré les données suivant un gradient.

L'effet Guttman est une conséquence d'une forte liaison entre les variables, et peut s'expliquer par l'existence d'un facteur beaucoup plus important que les autres, c'est à dire que l'un des facteurs dépend de manière quadratique du premier.

Cela permet d'obtenir les sites que se ressemblent ainsi que les espèces aillant des profils d'abondances se ressemblant.

# K-table

Je crois qu'il faut que je fasse une Foucart CoA

```{r}
# kplot()
k_table_format <- lapply(simulated_network$th_network, as.data.frame)

# class(k_table_format[[1]])

# is.ktab(lapply(dudi.ktable simulated_network$th_network, ))
# as.data.frame(simulated_network$th_network[[1]])
plot(foucart(lapply(simulated_network$th_network, as.data.frame), scannf = F, nf = 2))
plot(foucart(lapply(simulated_network$obs_network, as.data.frame), scannf = F, nf = 2))
```
