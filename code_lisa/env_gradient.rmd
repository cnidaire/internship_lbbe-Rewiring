---
title: "Generate series of interactions networks along an environmental gradient"
date: "`r Sys.Date()`"
output:
  rmdformats::material:
    highlight: kate
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```


```{r}
library(NetworkEnvGradGeneration)
library(ade4)

getwd()
# setwd("../../")
getwd()
source("plot.R")
source("formatting.R")
library(ggplot2)
```


```{r}
frame = 15
spe = 30
sampling_size = 200
test_1 <- env_grad_netw(nb_resource =spe , nb_consumer = spe, nb_location = frame, sd_tol_env = 1, ninter = sampling_size)
for (i in 1:frame) {
  p <- plot_matrix(data.frame(test_1$th_network[[i]]), 
            max_size = 15)  +
  theme(axis.text = element_blank(),
        axis.text.x.top = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        legend.position="none",
        plot.background = element_blank(),
        axis.line.x.top = element_line(colour = "darkorange4",
                                       linewidth = 3),
        axis.line.y = element_line(colour = "green4",
                                   linewidth = 3))
  if (i < 10) {
    ggsave(paste0("figure/test0",i, ".png"), width = spe/2, height = spe/2)
  }
  else {
    ggsave(paste0("figure/test",i, ".png"), width = spe/2, height = spe/2)
  }
}

```


# Beta diversity

## for abudance

```{r}
library(abind) # pour facilement fusionner des matrices 2D en une 3D

cor_abund_grad <- function(frame = 10, spe = 10){
  generated_netw <- env_grad_netw(nb_resource =spe , nb_consumer = spe, nb_location = frame)
  
  ### Beta diversity abundance ###
  full_abund <- cbind(generated_netw$abudance$abundance_resource, generated_netw$abudance$abundance_consumer)
  beta_div_abund <- matrix(,nrow = frame, ncol = frame)
  for (i in 1:frame) {
    for (j in i:frame) { # to have only the upper half
          c <- apply(full_abund[c(i, j), ], 2, min) # sum of the lesser values in shared between both samples
      beta_div_abund[i, j] <- 1- (2*sum(c) / (sum(full_abund[i,]) + sum(full_abund[j, ]))) # sum of the abundances of both samples
    }
  }
  beta_div_abund[beta_div_abund ==0] <- NA # to remove the identity diagonal
  
  ### Beta Diversity links ###
  beta_div_link <- matrix(,nrow = frame, ncol = frame)
  for (i in 1:frame) {
    for (j in i:frame) {
      c <- apply(abind(generated_netw$th_network[[i]], generated_netw$th_network[[j]], along = 3), c(1, 2), min)
      beta_div_link[i, j] <- 1 - (2*sum(c) / (sum(generated_netw$th_network[[i]]) + sum(generated_netw$th_network[[j]])))
    }
  }
  beta_div_link[beta_div_link == 0] <- NA
  
  ### Distance Environmental Gradient ###
  dist_env <- matrix(, nrow = frame, ncol = frame)
  for (i in 1:frame) {
    for (j in i:frame) {
      dist_env[i,j] = abs(i - j)
    }
  }
  dist_env[dist_env == 0] <- NA
  
  ### Correlation ###
  cor_abun_link <- cor(na.omit(as.vector(beta_div_abund)), na.omit(as.vector(beta_div_link)), method = "pearson")
  
  ### Results ###
  return(list(abundance = beta_div_abund, link = beta_div_link, env_grad = dist_env, correlation = cor_abun_link))
}
```

```{r}
network <- cor_abund_grad(frame = 100, spe = 20)
network$correlation
plot(network$env_grad, network$abundance, ylim = c(0, 1), ylab = "Beta div abundance", xlab = "Distance grad env")
```
La corÃ©lation entre les abondances et les liens sont quasi toujours > 80% et souvent > 90%.

```{r}
correlation_distrib <- vector(, length = 70)
for (i in 1:70) {
  network <- cor_abund_grad(frame = 10, spe = 20)
  correlation_distrib[i] <- network$correlation
}
hist(correlation_distrib, breaks = 10, xlim = c(0.6,1))
```

