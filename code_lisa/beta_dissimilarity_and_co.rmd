---
title: "beta_dissimilarity_and_co"
author: "RÃ©mi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(NetworkEnvGradGeneration)
library(ade4)
library(ggplot2)
library(bipartite)
# getwd()
```



# Network generation

```{r}
nb_frame <- 5; env_grad_max = 10
spe_resource <- 50; spe_consum <- 50
mean_tol_env = 2; sd_tol_env = 4
simulated_network <- env_grad_netw(nb_resource =spe_resource , nb_consumer = spe_consum,
                                   nb_location = nb_frame,
                                   # env_grad_max = env_grad_max,
                                   know_env_grad_pos = T, ninter = 500, 
                                   mean_tol = 15,
                                   mean_tol_env = mean_tol_env, sd_tol_env = sd_tol_env,
                                   delta = 1)

row.names(simulated_network$abudance$abundance_resource) <- paste0("site",1:nb_frame)
row.names(simulated_network$abudance$abundance_consumer) <- paste0("site",1:nb_frame)
```

```{r}
table.value(simulated_network$obs_network[[1]])
```

## Visualize the connected components

```{r}
library(igraph)
for (i in c(1:nb_frame)){
  plot(graph_from_incidence_matrix(simulated_network$obs_network[[i]][which(rowSums(simulated_network$obs_network[[i]]) != 0), which(colSums(simulated_network$obs_network[[i]]) != 0)]), vertex.size = 5)
}

```

# Dissimilartity

$\beta_{WN} = \beta_{ST} + \beta_{OS}$
Three categories (here for the interactions I think):
- a : belong to both networks
- b : belong only to the second network
- c : belong only to the first network

$\beta_{S}$ = composition dissimilarity between networks

$\beta_{ST}$ = species turnover (can not be computed directly)
$\beta_{OS}$ = changing interactions among species shared among sites $\Leftrightarrow$ rewiring (computed by only taking the species in common)

"The latter makes a strong case for using network approaches and investing the enormous effort in empirically recording interactions, as it highlights that knowing which species are there may not allow to predict interactions in a simple way (Poisot et al. 2015) and that interactions may be lost without losing species (Tylianakis et al. 2010)." (Frund 2021)

In this case, we mainly suggested that it would be due to a sampling bias and that the more species you are able to interact with, the higher the probability of randomly losing an interaction is when the sampling power is low.


## Between only two sites

Let's just make a first one where there is all the non 0 and then a second one without the unique ones that uniquely belong to one group

```{r}
# simulated_network$obs_network[[1]]

rm_unique_netw <- function(frame_1, frame_2){
  abs_row <- c(which(rowSums(simulated_network$obs_network[[frame_1]]) == 0),
               which(rowSums(simulated_network$obs_network[[frame_1]]) == 0))
  row_in_both <- c(1:dim(simulated_network$obs_network[[frame_1]])[1])
  row_in_both <- row_in_both[!(row_in_both %in% abs_row)]
  
  abs_col <- c(which(colSums(simulated_network$obs_network[[frame_1]]) == 0),
               which(colSums(simulated_network$obs_network[[frame_2]]) == 0))
  col_in_both <- c(1:dim(simulated_network$obs_network[[frame_1]])[2])
  col_in_both <- col_in_both[!(col_in_both %in% abs_col)]
  return(list(row_to_keep = row_in_both, col_to_keep = col_in_both))
}

filtered_location <- rm_unique_netw(1,2)

# table.value(simulated_network$obs_network[[1]][filtered_location$row_to_keep,filtered_location$col_to_keep])
# table.value(simulated_network$obs_network[[2]][filtered_location$row_to_keep,filtered_location$col_to_keep])

betalinkr_multi(abind::abind(simulated_network$obs_network[], along = 3), partitioning = "commondenom")
```



