---
title: "Interaction Network"
date: "`r Sys.Date()`"
output:
  rmdformats::material:
    highlight: kate
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```

```{r include=FALSE}
library(igraph)
library(tidyverse)
```


# Import file

```{r}
phenology_flower <-read.csv("./data/caradonna_rmbl_flowering_phenology_data_EDI.csv",header=T,sep=",",quot='"')
summary(phenology_flower)
```

check the format

```{r}
if (class(phenology_flower$year)=="factor") phenology_flower$year <-as.numeric(levels(phenology_flower$year))[as.integer(phenology_flower$year) ]               
if (class(phenology_flower$year)=="character") phenology_flower$year <-as.numeric(phenology_flower$year)
if (class(phenology_flower$site)!="factor") phenology_flower$site<- as.factor(phenology_flower$site)
if (class(phenology_flower$plant)!="factor") phenology_flower$plant<- as.factor(phenology_flower$plant)
if (class(phenology_flower$transect)!="factor") phenology_flower$transect<- as.factor(phenology_flower$transect)
if (class(phenology_flower$week_num)=="factor") phenology_flower$week_num <-as.numeric(levels(phenology_flower$week_num))[as.integer(phenology_flower$week_num) ]               
if (class(phenology_flower$week_num)=="character") phenology_flower$week_num <-as.numeric(phenology_flower$week_num)
if (class(phenology_flower$flower_count)=="factor") phenology_flower$flower_count <-as.numeric(levels(phenology_flower$flower_count))[as.integer(phenology_flower$flower_count) ]               
if (class(phenology_flower$flower_count)=="character") phenology_flower$flower_count <-as.numeric(phenology_flower$flower_count)

summary(phenology_flower)
```

# Import data interaction network

```{r}
interaction_netw <-read.csv("./data/caradonna_rmbl_interaction_networks_data_EDI.csv",header=T,sep=",",quot='"')
summary(interaction_netw)
```

Set the columns to the right format.

```{r}                
if (class(interaction_netw$year)=="factor") interaction_netw$year <-as.numeric(levels(interaction_netw$year))[as.integer(interaction_netw$year) ]               
if (class(interaction_netw$year)=="character") interaction_netw$year <-as.numeric(interaction_netw$year)
summary(interaction_netw)
```

# Work on a smaller subset

```{r}
# define a subset
sub_set = interaction_netw[phenology_flower$year == 2013 & interaction_netw$week_num == 2 & phenology_flower$transect == 1, c("pollinator", "plant")]

# Ajouter un filtre pour retirer les interaction en double.
sub_set <- distinct(sub_set)

# Make a dataframe of one column that contain an alternation of source and target vertices
edges_list = sub_set %>% transmute( merged = paste0(pollinator, ",", plant)) %>% separate_rows(merged, sep = ",")

# create a first dataframe in which there will be the nature of each vertex
vert <- rbind(data.frame(name = unique(sub_set$pollinator), cat = "pol"), data.frame(name = unique(sub_set$plant), cat = "pla"))
g <- graph_from_data_frame(sub_set, directed = T, vertices = vert)

vertex_col <- get.vertex.attribute(g, "cat")
colors = c("Green", "Yellow")
vertex_col[vertex_col == "pla"] = colors[1]
vertex_col[vertex_col == "pol"] = colors[2]

# add a type col to visualize the data
V(g)$type = bipartite_mapping(g)$type

plot(g, layout = layout_as_bipartite, vertex.color = vertex_col, edge.arrow.size = .4, vertex.label = NA)
```

# Do the same but for a different time frame

```{r warning=FALSE}
par(mfrow = c(2,3))
for (date_sample in sort(unique(interaction_netw$week_num))[1:6]) {
  # subset
  sub_set = interaction_netw[phenology_flower$year == 2013 & interaction_netw$week_num == date_sample & phenology_flower$transect == 1, c("pollinator", "plant")]
  # remove duplactes
  sub_set <- distinct(sub_set)
  # format the network
  edges_list = sub_set %>% transmute( merged = paste0(pollinator, ",", plant)) %>% separate_rows(merged, sep = ",")
  vert <- rbind(data.frame(name = unique(sub_set$pollinator), cat = "pol"), data.frame(name = unique(sub_set$plant), cat = "pla"))
  g <- graph_from_data_frame(sub_set, directed = T, vertices = vert)
  vertex_col <- get.vertex.attribute(g, "cat")
  colors = c("Green", "Yellow")
  vertex_col[vertex_col == "pla"] = colors[1]
  vertex_col[vertex_col == "pol"] = colors[2]
  V(g)$type = bipartite_mapping(g)$type
  plot(g, layout = layout_as_bipartite, vertex.color = vertex_col, edge.arrow.size = .4, vertex.label = NA, main = date_sample)
}

```

**Could be nice to have the vertices fixed so that we can have only the interactions moving and then, why not make a tiny animation out of it if it works (this way, we won't have many small graphs and it will be easier to see the modifications).**

# Make an animation

```{r}
# define a subset
sub_set = interaction_netw[phenology_flower$year == 2013 & interaction_netw$week_num == 1 & phenology_flower$transect == 1, c("pollinator", "plant")]

# Ajouter un filtre pour retirer les interaction en double.
sub_set <- distinct(sub_set)

# Make a dataframe of one column that contain an alternation of source and target vertices
edges_list = sub_set %>% transmute( merged = paste0(pollinator, ",", plant)) %>% separate_rows(merged, sep = ",")

# create a first dataframe in which there will be the nature of each vertex
vert <- rbind(data.frame(name = unique(interaction_netw$pollinator), cat = "pol"), data.frame(name = unique(interaction_netw$plant), cat = "pla"))
g <- graph_from_data_frame(sub_set, directed = T, vertices = vert)

vertex_col <- get.vertex.attribute(g, "cat")
colors = c("Green", "Yellow")
vertex_col[vertex_col == "pla"] = colors[1]
vertex_col[vertex_col == "pol"] = colors[2]

# add a type col to visualize the data
V(g)$type = bipartite_mapping(g)$type

layout_netw <- layout_as_bipartite(g)
layout_netw[12,2] = 0
plot(g, layout = layout_netw, vertex.color = vertex_col, edge.arrow.size = .4, vertex.label = NA)
```

```{r}
layout <- layout_as_bipartite(g)
```

```{r}
matrix(0, nrow = length(unique(interaction_netw$pollinator)) + length(unique(interaction_netw$pollinator)),ncol = 2)
```

# ggNetwork


# Propre

```{r}
library(igraph)
library(ggnetwork)
library(ggplot2)
library(dplyr)
library(tidyr)

# Define a subset
sub_set <- interaction_netw[phenology_flower$year == 2013 & interaction_netw$week_num == 2 & phenology_flower$transect == 1, c("pollinator", "plant")]

#  Remove duplicate interactions
sub_set <- distinct(sub_set)
```

## vertices

```{r}
# Make a dataframe of one column that contains an alternation of source and target vertices
edges_list <- sub_set %>%
  transmute(name = paste0(pollinator, ",", plant)) %>%
  separate_rows(name, sep = ",")

# Create a first dataframe in which there will be the nature of each vertex
vert <- rbind(data.frame(name = unique(sub_set$pollinator), cat = "pol"), 
              data.frame(name = unique(sub_set$plant), cat = "pla"))

# Create a directed graph
g <- graph_from_data_frame(sub_set, directed = TRUE, vertices = vert)

# Set layout positions manually
vert_pos <- data.frame(
  name = V(g)$name,
  x = 0,
  y = ifelse(V(g)$cat == "pol", 0, 1)
)

vert_pos[vert_pos$y == 0, "x"] = seq(0,1, by = 1/(length(vert_pos[vert_pos$y == 0, "x"])-1))
vert_pos[vert_pos$y != 0, "x"] = seq(0,1, by = 1/(length(vert_pos[vert_pos$y != 0, "x"])-1))
```

## edges

```{r}
edges_test = left_join(edges_list,vert_pos, by = "name")

start_pos = edges_test[seq(1, nrow(edges_test), by = 2), 2:3]
colnames(start_pos)[1:2] = c("x_start", "y_start")
end_pos = edges_test[seq(2, nrow(edges_test), by = 2), 2:3]
colnames(end_pos)[1:2] = c("x_end", "y_end")

edge_pos = cbind(start_pos,end_pos)


edge_pos$x_dist = edge_pos$x_end - edge_pos$x_start
edge_pos$y_dist = edge_pos$y_end - edge_pos$y_start
edge_pos[5:6] = edge_pos[5:6] * 0.98
edge_pos$x_end = edge_pos$x_start + edge_pos$x_dist
edge_pos$y_end = edge_pos$y_start + edge_pos$y_dist

# Get edge data for ggplot
edge_data <- as.data.frame(get.edgelist(g))
```

```{r}
# Plot the graph
ggplot() +
  geom_edges(data = edge_pos, aes(x = x_start, y = y_start, xend = x_end, yend = y_end), arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_nodes(data = vert_pos, aes(x = x, y = y, color = vert$cat), size = 3) +
  scale_color_manual(values = c("pol" = "#EECE00", "pla" = "#06CB21")) +
  theme_void() +
  theme(legend.position = "none") +
  coord_fixed()
```